#-*- coding: utf-8 -*-
import pefile
import logging
import collections
from . import conf, pefile_utils

mylogger = logging.getLogger(__name__)
mylogger.setLevel(logging.DEBUG)
sh = logging.StreamHandler()
mylogger.addHandler(sh)

def extract_dos_header(pe):
    '''
    PE헤더의 DOS헤더 추출 함수
    :param pefile의 pe
    :return 추출한 DOS헤더의 리스트
    '''
    try:
        dos_hedaer = pefile_utils.get_peheader(pe, 'DOS_HEADER')
        dos_hedaer['e_res'] = int.from_bytes(pe.DOS_HEADER.e_res, byteorder='little')
        dos_hedaer['e_res2'] = int.from_bytes(pe.DOS_HEADER.e_res2, byteorder='little')

        return dos_hedaer

    except Exception as e:
        mylogger.debug(e)
        return None

def extract_optional_header(pe):
    '''
    PE헤더의 OPTIONAL 추출 함수
    :param pefile의 pe
    :return 추출한 OPTIONAL헤더 리스트
    '''
    try:
        optional_header = pefile_utils.get_peheader(pe, 'OPTIONAL_HEADER')

        return optional_header

    except Exception as e:
        mylogger.debug(e)
        return None

def extract_file_header(pe):
    '''
    FILE헤더 추출
    :param pe:
    :return:추출한 FILE헤더 리스트
    '''
    try:
        file_header = pefile_utils.get_peheader(pe, 'FILE_HEADER')
        file_header['TimeDateStamp'] = pe.FILE_HEADER.TimeDateStamp

        return file_header

    except Exception as e:
        mylogger.debug(e)
        return None

def convert_to_printable(s):
    '''

    '''

def extract_file_info(pe):
    '''
    파일 메타데이터 추출
    참고자료: pescanner: https://github.com/Te-k/analyst-scripts/blob/master/pe/pescanner.py
    '''
    ret = []

    if hasattr(pe, 'VS_VERSIONINFO'):
        if hasattr(pe, 'FileInfo'):
            for entry in pe.FileInfo:
                if hasattr(entry, 'StringTable'):
                    for st_entry in entry.StringTable:
                        for str_entry in st_entry.entries.items():
                            print(str_entry)
