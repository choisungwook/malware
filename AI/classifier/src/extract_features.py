#-*- coding: utf-8 -*-
import raw_features
import pefile
import sys
import logging
import pandas as pd
import csv

mylogger = logging.getLogger('extract_features')
mylogger.setLevel(logging.INFO)

'''
추출하는 특성 리스트
'''

#DOS 헤더
DOS_HEADER = ["e_magic","e_cblp","e_cp", "e_crlc","e_cparhdr","e_minalloc","e_maxalloc","e_ss","e_sp",\
 "e_csum","e_ip","e_cs","e_lfarlc","e_ovno","e_res","e_oemid","e_oeminfo","e_res2","e_lfanew"]

FILE_HEADER= ["Machine","NumberOfSections","CreationYear","PointerToSymbolTable", \
              "NumberOfSymbols","SizeOfOptionalHeader","Characteristics"]

OPTIONAL_HEADER = ["Magic","MajorLinkerVersion","MinorLinkerVersion","SizeOfCode","SizeOfInitializedData",\
"SizeOfUninitializedData","AddressOfEntryPoint",\
"BaseOfCode","ImageBase","SectionAlignment","FileAlignment",\
"MajorOperatingSystemVersion","MinorOperatingSystemVersion",\
"MajorImageVersion",\
"MinorImageVersion",\
"MajorSubsystemVersion",\
"MinorSubsystemVersion",\
"SizeOfImage",\
"SizeOfHeaders",\
"CheckSum",\
"Subsystem",\
"DllCharacteristics",\
"SizeOfStackReserve",\
"SizeOfStackCommit",\
"SizeOfHeapReserve",\
"SizeOfHeapCommit",\
"LoaderFlags",\
"NumberOfRvaAndSizes"]

# 타겟
target = 'C:\\Windows\\notepad.exe'
output = 'test_features.csv'

try:
    pe = pefile.PE(target)

    '''
        PE포맷의 DOS헤더 추출
        실패시 프로그램 종료
    '''
    dos_header = raw_features.extract_dos_header(pe)
    if dos_header is None:
        mylogger.info('Extracting dos_header is failed')
        sys.exit(-1)

    '''
        PE포맷의 OPTIONAL헤더 추출
        실패시 프로그램 종료
    '''
    optional_header = raw_features.extract_optional_header(pe)
    if optional_header is None:
        mylogger.info('Extracting optional_header is failed')
        sys.exit(-1)

    file_header = raw_features.extract_file_header(pe)
    if file_header is None:
        mylogger.info('Extracting file_header is failed')
        sys.exit(-1)

    # 파일 쓰기
    with open(output, 'wt') as f:
        writer = csv.writer(f)
        writer.writerow(pe.__IMAGE_DOS_HEADER_format__[1])

        # 컬럼 이름
        #writer.writerow(DOS_HEADER + FILE_HEADER + OPTIONAL_HEADER)
        # 추출한 특성
        #writer.writerow(dos_header + file_header+ optional_header)

except Exception as e:
    mylogger.info('Load PE is failed')

print('Done')