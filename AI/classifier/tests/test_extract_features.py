#-*- coding: utf-8 -*-
import unittest
import sys
import os
import pefile
import csv

sys.path.append(os.path.dirname(os.path.abspath(os.path.dirname(__file__))))
from src import raw_features, extra_features, conf

class Textarea(unittest.TestCase):
    def setUp(self):
        '''
        테스트 시작되기 전 초기화 코드
        '''
        self.target = conf.testtarget
        self.pe = pefile.PE(self.target)

    def test_extract_dos_header(self):
        '''
        DOS헤더 추출 테스트
        '''
        dos_header = raw_features.extract_dos_header(self.pe)
        print(dos_header)

        # 추출 개수와 DOS헤더 개수 검사
        self.assertEqual(len(dos_header), len(conf.__IMAGE_DOS_HEADER_format__[1]))

    def test_extract_dosheader_And_write_csv(self):
        '''
        DOS헤더를 추출하고 csv파일로 쓰기
        '''
        # csv파일 경로
        output = 'dos_header.csv'
        dos_header = raw_features.extract_dos_header(self.pe)

        with open(output, 'wt') as f:
            writer = csv.writer(f, lineterminator='\n')

            # 헤더 쓰기
            writer.writerow(list(conf.__IMAGE_DOS_HEADER_format__[1]))

            # 추출한 도스헤더 쓰기
            writer.writerow(dos_header.values())

        print('Test_extract_dosheader_And_write_csv function is Done')

    def test_extract_optional_header_1(self):
        '''
        OPTIONAL헤더 추출 테스트 1
        OrderDict 변환 테스트
        '''

        optional_header = raw_features.extract_optional_header(self.pe)
        self.assertEqual(len(optional_header), len(conf.__IMAGE_OPTIONAL_HEADER_format__[1]))

    def test_extract_optional_header_2(self):
        '''
        1. DOS헤더 + OPTINAL헤더 추출
        2. csv파일에 저장
        '''
        output = 'dos_optional_header.csv'

        dos_header = raw_features.extract_dos_header(self.pe)
        optional_header = raw_features.extract_optional_header(self.pe)

        with open(output, 'wt') as f:
            writer = csv.writer(f, lineterminator='\n')

            # 헤더 쓰기
            writer.writerow(list(conf.__IMAGE_DOS_HEADER_format__[1]) + list(conf.__IMAGE_OPTIONAL_HEADER_format__[1]))

            # DOS 헤더 + OPTIONAL 헤더
            features = list(dos_header.values()) + list(optional_header.values())
            writer.writerow(features)

        print('test_extract_optional_header_2 is Done')

    def test_extract_file_header1(self):
        '''
        FILE 헤더 추출 테스트 1
        OrderDict 변환 테스트
        '''

        file_header = raw_features.extract_file_header(self.pe)
        self.assertEqual(len(file_header), len(conf.__IMAGE_FILE_HEADER_format__[1]))

        print('test_extract_file_header1 is Done')

    def test_extract_file_header2(self):
        '''
        FILE 헤더 추출 테스트 2
        추출한 파일 헤더를 csv파일로 저장
        '''
        output = 'file_header.csv'
        file_header = raw_features.extract_file_header(self.pe)

        with open(output, 'wt') as f:
            writer = csv.writer(f, lineterminator='\n')

            # 헤더
            columns = list(conf.__IMAGE_FILE_HEADER_format__[1])

            # 값
            features = list(file_header.values())

            writer.writerow(columns)
            writer.writerow(features)

        print('test_extract_file_header2 is Done')


    def test_extract_section_name(self):
        '''
        악성코드에 자주 출현하는 섹션 이름 추출
        '''
        sections = extra_features.get_count_suspicious_sections(self.pe)
        print(sections)


if __name__=='__main__':
    unittest.main()